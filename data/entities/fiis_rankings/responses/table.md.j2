{% set rows = rows if rows is defined else [] %}
{# Só hidrata rows via results se rows estiver vazio (rewrite_only-safe) #}
{% if (not rows) and results is defined and meta is defined and meta.result_key is defined and (meta.result_key in results) %}
  {% set rows = results[meta.result_key] %}
{% endif %}

{% if rows and rows|length > 0 -%}
  {% set rows_sorted = rows | sort(attribute='ticker') %}
  {% set grouped = rows_sorted | groupby('ticker') %}

  {% for ticker, items in grouped %}
| Código | Ranking usuários | Mov. usuários | Ranking Sírios | Mov. Sírios | Ranking IFIX | Mov. IFIX | Ranking IFIL | Mov. IFIL | Rank DY 12m | Rank DY mensal | Rank dividendos 12m | Rank valor de mercado | Rank patrimônio líquido | Rank Sharpe | Rank Sortino | Rank menor volatilidade | Rank menor drawdown | Criado em | Atualizado em |
| --- | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | --- | --- |
{% for r in items %}
| {{ r.ticker or '-' }} | {{ r.users_rank_position if r.users_rank_position is not none else '-' }} | {{ r.users_rank_net_movement if r.users_rank_net_movement is not none else '-' }} | {{ r.sirios_rank_position if r.sirios_rank_position is not none else '-' }} | {{ r.sirios_rank_net_movement if r.sirios_rank_net_movement is not none else '-' }} | {{ r.ifix_rank_position if r.ifix_rank_position is not none else '-' }} | {{ r.ifix_rank_net_movement if r.ifix_rank_net_movement is not none else '-' }} | {{ r.ifil_rank_position if r.ifil_rank_position is not none else '-' }} | {{ r.ifil_rank_net_movement if r.ifil_rank_net_movement is not none else '-' }} | {{ r.rank_dy_12m if r.rank_dy_12m is not none else '-' }} | {{ r.rank_dy_monthly if r.rank_dy_monthly is not none else '-' }} | {{ r.rank_dividends_12m if r.rank_dividends_12m is not none else '-' }} | {{ r.rank_market_cap if r.rank_market_cap is not none else '-' }} | {{ r.rank_equity if r.rank_equity is not none else '-' }} | {{ r.rank_sharpe if r.rank_sharpe is not none else '-' }} | {{ r.rank_sortino if r.rank_sortino is not none else '-' }} | {{ r.rank_low_volatility if r.rank_low_volatility is not none else '-' }} | {{ r.rank_low_drawdown if r.rank_low_drawdown is not none else '-' }} | {{ r.created_at if r.created_at else '-' }} | {{ r.updated_at if r.updated_at else '-' }} |
{% endfor %}

{% if not loop.last %}

---

{% endif %}
  {% endfor %}
{%- else -%}
{{ empty_message or "Nenhum registro encontrado." }}
{%- endif %}
