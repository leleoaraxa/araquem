{% set rows = rows if rows is defined else [] %}
{# Só hidrata rows via results se rows estiver vazio (rewrite_only-safe) #}
{% if (not rows) and results is defined and meta is defined and meta.result_key is defined and (meta.result_key in results) %}
  {% set rows = results[meta.result_key] %}
{% endif %}

{% if rows and rows|length > 0 -%}
  {# Histórico: ordenar por data e depois ticker; groupby exige ordenação por ticker #}
  {% set rows_sorted = rows | sort(attribute='traded_at') | sort(attribute='ticker') %}
  {% set grouped = rows_sorted | groupby('ticker') %}

  {% for ticker, items in grouped %}
| Data | Código | Preço de fechamento (R$) | Preço ajustado (R$) | Abertura (R$) | Máxima (R$) | Mínima (R$) | Variação diária (%) | Criado em | Atualizado em |
| --- | --- | ---: | ---: | ---: | ---: | ---: | ---: | --- | --- |
{% for r in items %}
| {{ r.traded_at | date_br if r.traded_at else '-' }} | {{ r.ticker or '-' }} | {{ r.close_price | currency_br if r.close_price is not none else '-' }} | {{ r.adj_close_price | currency_br if r.adj_close_price is not none else '-' }} | {{ r.open_price | currency_br if r.open_price is not none else '-' }} | {{ r.max_price | currency_br if r.max_price is not none else '-' }} | {{ r.min_price | currency_br if r.min_price is not none else '-' }} | {{ r.daily_variation_pct | percent_raw_br if r.daily_variation_pct is not none else '-' }} | {{ r.created_at | datetime_br if r.created_at else '-' }} | {{ r.updated_at | datetime_br if r.updated_at else '-' }} |
{% endfor %}

{% if not loop.last %}

---

{% endif %}
  {% endfor %}
{%- else -%}
{{ empty_message or "Nenhum registro encontrado." }}
{%- endif %}
