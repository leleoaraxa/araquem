terms:
- name: narrator
  kind: policy
  scope: narrator
  version: 1

narrator:
  model: sirios-narrator:latest
  llm_enabled: true
  shadow: false

  # policy_guards é um contrato declarativo de governança (não garante aplicação automática).
  # O enforcement só ocorre quando implementado no runtime, fora deste escopo.
  # O baseline citado é a resposta pós-SQL formatada (Formatter/Jinja).
  policy_guards:
    # (6) Timeout conservador para o narrador em modo rewrite-only.
    timeout_seconds: 6
    # (7) Garante que o padrão global permaneça rewrite-only.
    rewrite_only_default: true
    # (8) Invariantes proibidas para evitar alterações indevidas.
    invariants_prohibited:
      - change_numbers_or_dates
      - change_tickers
      - change_urls
      - emit_markdown_tables
      - emit_pipe_tables
    # (9) Fail-closed/fallback determinístico.
    fail_closed:
      # baseline = resposta pós-SQL formatada (Formatter/Jinja).
      on_violation: return_baseline
      on_error: return_baseline
      on_timeout: return_baseline

  # Objetivo operacional:
  # - reduzir p95/p99 do /ask removendo LLM de respostas numéricas/tabelares
  # - manter LLM apenas onde agrega valor (macro/overview conceitual)

  # Buckets:
  # - A/B/C → SQL-only (llm_enabled=false via entities)
  buckets:
    A:
      llm_enabled: false
    B:
      llm_enabled: false
    C:
      llm_enabled: false
  default:
    # Default agora é SQL-first: LLM somente quando uma entidade habilitar explicitamente.
    llm_enabled: false
    shadow: false
    model: sirios-narrator:latest
    style: executivo

    # Limites de uso do LLM
    # (quando uma entidade habilitar LLM)
    max_llm_rows: 20
    max_prompt_tokens: 900
    max_output_tokens: 220

    # RAG / contexto
    use_rag_in_prompt: false
    use_conversation_context: false
    rag_snippet_max_chars: 320
    prefer_concept_when_no_ticker: true
    rag_fallback_when_no_rows: false
    concept_with_data_when_rag: false

  entities:
    # ──────────────────
    # Núcleo de RISCO
    # ──────────────────
    # Receita indexada (IPCA/CDI etc.) – por enquanto sem LLM
    fiis_financials_revenue_schedule:
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 0
      use_rag_in_prompt: false
      use_conversation_context: false
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: false
      strict_mode: false

    # ──────────────────
    # Série histórica de mercado / macro
    # ──────────────────
    history_market_indicators:
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 5
      rag_snippet_max_chars: 260
      use_rag_in_prompt: true
      use_conversation_context: false
      prefer_concept_when_no_ticker: true
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: true
      strict_mode: false

    history_b3_indexes:
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 5
      rag_snippet_max_chars: 260
      use_rag_in_prompt: true
      use_conversation_context: false
      prefer_concept_when_no_ticker: true
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: true
      strict_mode: false

    history_currency_rates:
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 5
      rag_snippet_max_chars: 260
      use_rag_in_prompt: true
      use_conversation_context: false
      prefer_concept_when_no_ticker: true
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: true
      strict_mode: false

    # ──────────────────
    # Overview / yield / carteira
    # ──────────────────
    fiis_overview:
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 10
      max_prompt_tokens: 700
      max_output_tokens: 180
      use_rag_in_prompt: false
      use_conversation_context: false
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: false
      strict_mode: false
      instruction: |
        Escreva apenas um prefácio curto (máximo 5 linhas) respondendo ao que o usuário perguntou,
        usando os dados como âncora factual. Proibido: tabelas, pipes (|), markdown tabular,
        repetir o texto base, ou listar colunas/linhas. Não invente dados; não altere números/datas.

    fiis_yield_history:
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 0
      use_rag_in_prompt: false
      use_conversation_context: false
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: false
      strict_mode: false

    fiis_dividends_yields:
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 0
      use_rag_in_prompt: false
      use_conversation_context: false
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: false
      strict_mode: false

    client_fiis_enriched_portfolio:
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 0
      use_rag_in_prompt: false
      use_conversation_context: false
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: false
      strict_mode: false

    consolidated_macroeconomic:
      llm_enabled: true
      mode: global_post_sql
      shadow: false
      rewrite_only: false
      max_llm_rows: 0
      max_rows: 5
      max_columns: 6
      max_prompt_tokens: 1200
      max_output_tokens: 280
      max_tokens: 512
      temperature: 0.1
      use_rag_in_prompt: false
      use_conversation_context: false
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: false
      strict_mode: false
      instruction: |
        Atue como Narrator de cenário macro consolidado para FIIs, usando as linhas da
        entidade como âncora factual para juros, inflação, câmbio e índices locais.
        Entregue um snapshot interpretativo do ambiente macro (Selic/CDI, IPCA e
        dólar), explicando como a dinâmica de taxas e inflação tende a afetar FIIs de
        tijolo e de papel. Relacione Selic, CDI e IPCA ao desempenho típico dos FIIs e
        destaque se o contexto está mais favorável ou desfavorável para quem busca
        renda com FIIs.

    institutional_about:
      llm_enabled: false
      shadow: false

    institutional_privacy:
      llm_enabled: false
      shadow: false

    institutional_terms:
      llm_enabled: false
      shadow: false

    institutional_limits:
      llm_enabled: false
      shadow: false

    institutional_pricing:
      llm_enabled: false
      shadow: false

    support_howto_core:
      llm_enabled: false
      shadow: false

    # ──────────────────
    # Cadastro / preços / processos / rankings / notícias / riscos
    # ──────────────────
    fiis_financials_risk:
      # Desliga LLM: latência alta e resposta é essencialmente numérica/estruturada.
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 10
      instruction: |
        Escreva apenas um prefácio curto (máximo 5 linhas) respondendo ao que o usuário perguntou,
        usando os dados de risco como âncora factual (ex.: volatilidade, sharpe, sortino, drawdown,
        beta e demais métricas presentes). Proibido: tabelas, pipes (|), markdown tabular,
        repetir o texto base, ou listar colunas/linhas. Não invente dados; não altere números/datas.
      max_output_tokens: 0
      use_rag_in_prompt: false
      use_conversation_context: false
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: false
      strict_mode: false

    fiis_news:
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 0
      use_rag_in_prompt: false
      use_conversation_context: false
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: false
      strict_mode: false

    fiis_registrations:
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 0
      use_rag_in_prompt: false
      use_conversation_context: false
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: false
      strict_mode: false

    fiis_dividends:
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 0
      use_rag_in_prompt: false
      use_conversation_context: false
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: false
      strict_mode: false

    fiis_financials_snapshot:
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 10
      use_rag_in_prompt: false
      use_conversation_context: false
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: false
      strict_mode: false
      max_output_tokens: 0
      instruction: |
        Escreva apenas um prefácio curto (máximo 5 linhas) respondendo ao que o usuário perguntou,
        usando os dados como âncora factual. Proibido: tabelas, pipes (|), markdown tabular,
        repetir o texto base, ou listar colunas/linhas. Não invente dados; não altere números/datas.

    fiis_real_estate:
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 0
      use_rag_in_prompt: false
      use_conversation_context: false
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: false
      strict_mode: false

    fiis_quota_prices:
      # Desliga LLM: foi o principal causador de 40s+ nos testes (prefácio não compensa).
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 10
      use_rag_in_prompt: false
      use_conversation_context: false
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: false
      strict_mode: false
      max_output_tokens: 0
      instruction: |
        Escreva apenas um prefácio curto (máximo 5 linhas) respondendo ao que o usuário perguntou,
        usando os dados como âncora factual. Proibido: tabelas, pipes (|), markdown tabular,
        repetir o texto base, ou listar colunas/linhas. Não invente dados; não altere números/datas.

    fiis_legal_proceedings:
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 0
      use_rag_in_prompt: false
      use_conversation_context: false
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: false
      strict_mode: false

    fiis_rankings:
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 10
      use_rag_in_prompt: false
      use_conversation_context: false
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: false
      strict_mode: false
      max_output_tokens: 0
      instruction: |
        Escreva apenas um prefácio curto (máximo 5 linhas) respondendo ao que o usuário perguntou,
        usando os dados como âncora factual. Proibido: tabelas, pipes (|), markdown tabular,
        repetir o texto base, ou listar colunas/linhas. Não invente dados; não altere números/datas.

    # ──────────────────
    # Entidades do cliente (posições / desempenho / dividendos evol.)
    # ──────────────────
    client_fiis_positions:
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 0
      use_rag_in_prompt: false
      use_conversation_context: false
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: false
      strict_mode: false

    client_fiis_dividends_evolution:
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 0
      use_rag_in_prompt: false
      use_conversation_context: false
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: false
      strict_mode: false

    client_fiis_performance_vs_benchmark:
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 0
      use_rag_in_prompt: false
      use_conversation_context: false
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: false
      strict_mode: false

    client_fiis_performance_vs_benchmark_summary:
      llm_enabled: false
      shadow: false
      rewrite_only: false
      max_llm_rows: 0
      use_rag_in_prompt: false
      use_conversation_context: false
      rag_fallback_when_no_rows: false
      concept_with_data_when_rag: false
      strict_mode: false
