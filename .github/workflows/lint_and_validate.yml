name: Lint & Validate
on:
  pull_request:
  push:
    paths:
      - 'data/**'
      - 'grafana/**'
      - 'scripts/**'
      - '.github/**'
jobs:
  lint-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install ruamel.yaml jsonschema
      - name: YAML/JSON syntax
        run: |
          python - << 'PY'
          import sys, json, pathlib
          from ruamel.yaml import YAML
          y=YAML(typ='safe')
          errs=0
          for p in pathlib.Path('data').rglob('*.y*ml'):
            try: y.load(p.read_text(encoding='utf-8', errors='ignore'))
            except Exception as e:
              print(f'YAML ERROR: {p}: {e}'); errs+=1
          for p in pathlib.Path('grafana').rglob('*.json'):
            try: json.loads(p.read_text(encoding='utf-8', errors='ignore'))
            except Exception as e:
              print(f'JSON ERROR: {p}: {e}'); errs+=1
          sys.exit(1 if errs else 0)
          PY
      - name: Check duplicated tokens/antitokens (best-effort)
        run: |
          python - << 'PY'
          import re, pathlib, sys
          toks=[]
          for p in pathlib.Path('data/ontology').rglob('*.y*ml'):
            t=p.read_text(encoding='utf-8', errors='ignore')
            for m in re.findall(r'\b(include|exclude):\s*\[(.*?)\]', t, flags=re.S):
              toks+=re.findall(r'"(.*?)"|\b(\w+)\b', m[1])
          # Simplistic duplicate check (casefold)
          flat=[(a or b).casefold() for a,b in toks if (a or b)]
          dups=sorted(set([x for x in flat if flat.count(x)>1]))
          if dups:
            print('DUP TOKENS:', ', '.join(dups))
          sys.exit(0)
          PY
