name: CI

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt
          sudo apt-get update && sudo apt-get install -y prometheus

      - name: Generate Grafana dashboards (deterministic)
        run: |
          python scripts/gen_dashboards.py --config data/ops/observability.yaml --out grafana/dashboards

      - name: Generate Prometheus rules (deterministic)
        run: |
          python scripts/gen_alerts.py --config data/ops/observability.yaml

      - name: Promtool check rules (optional)
        run: |
          if command -v promtool > /dev/null; then
            promtool check rules prometheus/recording_rules.yml
            promtool check rules prometheus/alerting_rules.yml
          else
            echo "::warning:: promtool not found; skipping syntax check"
          fi

      - name: Run auditor (anti-drift)
        run: |
          python scripts/obs_audit.py

      - name: Pytest
        run: |
          pytest -q
