{% set rows = rows if rows is defined else [] %}

{% if rows and rows|length > 0 -%}
  {% set tickers = rows | map(attribute='ticker') | unique | list %}
  {% for ticker in tickers %}
    {% set subset = rows | selectattr('ticker', 'equalto', ticker) | list %}

    {# "latest" robusto sem depender do ORDER BY do SQL #}
    {% set latest = (subset | sort(attribute='ref_month', reverse=true) | first) %}

    **Dividend yield mensal de {{ ticker }}**

    Último mês em {{ latest.ref_month if latest.ref_month is not none else '-' }}: dividendos **{{ latest.dividends_sum if latest.dividends_sum is not none else '-' }}**; DY mensal **{{ latest.dy_monthly if latest.dy_monthly is not none else '-' }}**.

    | Mês de referência | Dividendos (R$) | Preço ref. (R$) | DY mensal |
    | --- | --- | --- | --- |
    {% for r in subset %}
      | {{ r.ref_month if r.ref_month is not none else '-' }} | {{ r.dividends_sum if r.dividends_sum is not none else '-' }} | {{ r.price_ref if r.price_ref is not none else '-' }} | {{ r.dy_monthly if r.dy_monthly is not none else '-' }} |
    {% endfor %}

    {%- if not loop.last %}

---

    {%- endif %}
  {%- endfor %}
{%- else -%}
  {{ empty_message or "Nenhum registro encontrado." }}
{%- endif %}
