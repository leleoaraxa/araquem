{% set rows = rows if rows is defined else [] %}

{% if rows and rows|length > 0 -%}
  {% set tickers = rows | map(attribute='ticker') | unique | list %}
  {% for ticker in tickers %}
    {% set subset = rows | selectattr('ticker', 'equalto', ticker) | list %}
    {% set latest = subset[0] %}
    **Dividend yield mensal de {{ ticker }}**

    Último mês em {{ latest.ref_month|date_br if latest.ref_month is not none else '-' }}: dividendos **{{ latest.dividends_sum|currency_br if latest.dividends_sum is not none else '-' }}**; DY mensal **{{ latest.dy_monthly|percent_br if latest.dy_monthly is not none else '-' }}**.

    | Mês de referência | Dividendos (R$) | Preço ref. (R$) | DY mensal |
    | --- | --- | --- | --- |
    {% for r in subset %}
      | {{ r.ref_month|date_br if r.ref_month is not none else '-' }} | {{ r.dividends_sum|currency_br if r.dividends_sum is not none else '-' }} | {{ r.price_ref|currency_br if r.price_ref is not none else '-' }} | {{ r.dy_monthly|percent_br if r.dy_monthly is not none else '-' }} |
    {% endfor %}

  {%- endfor %}
{%- else -%}
  {{ empty_message or "Nenhum registro encontrado." }}
{%- endif %}
