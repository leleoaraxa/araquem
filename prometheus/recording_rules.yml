groups:
  - name: sirios_recording_api
    interval: 5m
    rules:
      - record: job:api_requests_per_s:rate
        expr: sum(rate(api_requests_total[5m])) by (job)
      - record: job:api_errors_per_s:rate
        expr: sum(rate(api_errors_total[5m])) by (job)
      - record: job:api_error_rate:ratio
        expr: clamp_min(job:api_errors_per_s:rate / job:api_requests_per_s:rate, 0)

      # Latência p50/p95/p99 (histogram_quantile)
      - record: job:api_latency_ms:p50
        expr: histogram_quantile(0.50, sum(rate(api_latency_ms_bucket[5m])) by (le, job))
      - record: job:api_latency_ms:p95
        expr: histogram_quantile(0.95, sum(rate(api_latency_ms_bucket[5m])) by (le, job))
      - record: job:api_latency_ms:p99
        expr: histogram_quantile(0.99, sum(rate(api_latency_ms_bucket[5m])) by (le, job))

  - name: sirios_recording_cache
    interval: 5m
    rules:
      - record: job:cache_hits_per_s:rate
        expr: sum(rate(cache_hits_total[5m])) by (job)

      - record: job:cache_misses_per_s:rate
        expr: sum(rate(cache_misses_total[5m])) by (job)

      # Fração 0–1 (não em %). Deixa o *100 para o painel do Grafana.
      - record: job:cache_hit_ratio:ratio
        expr: job:cache_hits_per_s:rate
              / clamp_min(job:cache_hits_per_s:rate + job:cache_misses_per_s:rate, 1e-6)


  - name: sirios_recording_rag
    interval: 5m
    rules:
      - record: job:rag_last_refresh_age_seconds
        expr: time() - rag_index_last_refresh_timestamp
      - record: job:rag_density_score
        expr: avg(rag_index_density_score)
