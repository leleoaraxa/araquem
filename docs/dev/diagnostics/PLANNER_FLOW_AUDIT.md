# Auditoria do Planner (roteamento single vs multi ticker)

## Fluxo real do Planner
- Normalização/tokenização conforme ontologia (steps e regex de split).
- Extração de ticker via ticker_index (exact/prefix4) sem alterar score.
- Bucket via data/ontology/bucket_rules.yaml seguido de filtro de entidades.
- Scoring base por tokens/phrases + anti-penalty, fusão opcional com RAG, e gate por thresholds.

## Casos com 1 ticker vs multi ticker
- **Como está KNRI11 e XPLG11?** — tickers: ['KNRI11', 'XPLG11'] → chosen: ticker_query / fiis_quota_prices (accepted=True)
- **Preço do KNRI11 e do XPLG11 hoje** — tickers: ['KNRI11', 'XPLG11'] → chosen: fiis_quota_prices / fiis_quota_prices (accepted=True)
- **Dividendos de KNRI11 e XPLG11** — tickers: ['KNRI11', 'XPLG11'] → chosen: ticker_query / fiis_quota_prices (accepted=False)
- **Quais são os imóveis do KNRI11 e XPLG11?** — tickers: ['KNRI11', 'XPLG11'] → chosen: fiis_real_estate / fiis_real_estate (accepted=True)
- **Tem notícias do KNRI11 e do XPLG11?** — tickers: ['KNRI11', 'XPLG11'] → chosen: fiis_news / fiis_news (accepted=True)
- **Como está KNRI11 agora?** — tickers: ['KNRI11'] → chosen: ticker_query / fiis_quota_prices (accepted=True)
- **Preço do KNRI11 hoje** — tickers: ['KNRI11'] → chosen: fiis_quota_prices / fiis_quota_prices (accepted=True)
- **Dividendos do KNRI11** — tickers: ['KNRI11'] → chosen: fiis_dividends / fiis_dividends (accepted=True)
- **Imóveis do KNRI11** — tickers: ['KNRI11'] → chosen: fiis_real_estate / fiis_real_estate (accepted=True)
- **Notícias do KNRI11** — tickers: ['KNRI11'] → chosen: fiis_news / fiis_news (accepted=True)
- **Como está hoje?** — tickers: [] → chosen: ticker_query / fiis_quota_prices (accepted=False)
- **Quais são os melhores FIIs no ranking?** — tickers: [] → chosen: fiis_rankings / fiis_rankings (accepted=True)
- **Qual foi o valor do IPCA em março de 2025?** — tickers: [] → chosen: history_market_indicators / history_market_indicators (accepted=True)
- **Como está KNRI agora?** — tickers: ['KNRI11'] → chosen: ticker_query / fiis_quota_prices (accepted=True)
- **Dividendos de XPLG** — tickers: ['XPLG11'] → chosen: ticker_query / fiis_quota_prices (accepted=False)

## Onde falha e por quê (com evidência)
- Como está KNRI11 e XPLG11?: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['cap rate', 'classe processual', 'compra e venda', 'enterprise value', 'mes a mes', 'patrimonio liquido', 'por mes', 'preco medio', 'processo numero', 'publico alvo', 'quantidade processos', 'razao social', 'tipo de fundo', 'valor da empresa', 'valor de mercado', 'valor patrimonial', 'valor patrimonial cota'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.9, 'min_gap': 0.05, 'gap': 1.1, 'accepted': True, 'source': 'base'}
- Preço do KNRI11 e do XPLG11 hoje: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['cap rate', 'classe processual', 'compra e venda', 'enterprise value', 'mes a mes', 'patrimonio liquido', 'por mes', 'preco medio', 'processo numero', 'publico alvo', 'quantidade processos', 'razao social', 'tipo de fundo', 'valor da empresa', 'valor de mercado', 'valor patrimonial', 'valor patrimonial cota'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.9, 'min_gap': 0.05, 'gap': 4.4, 'accepted': True, 'source': 'base'}
- Dividendos de KNRI11 e XPLG11: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['cap rate', 'classe processual', 'compra e venda', 'enterprise value', 'mes a mes', 'patrimonio liquido', 'por mes', 'preco medio', 'processo numero', 'publico alvo', 'quantidade processos', 'razao social', 'tipo de fundo', 'valor da empresa', 'valor de mercado', 'valor patrimonial', 'valor patrimonial cota'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.9, 'min_gap': 0.05, 'gap': -1.1, 'accepted': False, 'source': 'base'}
- Quais são os imóveis do KNRI11 e XPLG11?: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['cap rate', 'classe processual', 'compra e venda', 'enterprise value', 'mes a mes', 'patrimonio liquido', 'por mes', 'preco medio', 'processo numero', 'publico alvo', 'quantidade processos', 'razao social', 'tipo de fundo', 'valor da empresa', 'valor de mercado', 'valor patrimonial', 'valor patrimonial cota'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.85, 'min_gap': 0.1, 'gap': 7.699999999999999, 'accepted': True, 'source': 'base'}
- Tem notícias do KNRI11 e do XPLG11?: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['cap rate', 'classe processual', 'compra e venda', 'enterprise value', 'mes a mes', 'patrimonio liquido', 'por mes', 'preco medio', 'processo numero', 'publico alvo', 'quantidade processos', 'razao social', 'tipo de fundo', 'valor da empresa', 'valor de mercado', 'valor patrimonial', 'valor patrimonial cota'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.8, 'min_gap': 0.1, 'gap': 4.4, 'accepted': True, 'source': 'base'}
- Como está KNRI11 agora?: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['cap rate', 'classe processual', 'compra e venda', 'enterprise value', 'mes a mes', 'patrimonio liquido', 'por mes', 'preco medio', 'processo numero', 'publico alvo', 'quantidade processos', 'razao social', 'tipo de fundo', 'valor da empresa', 'valor de mercado', 'valor patrimonial', 'valor patrimonial cota'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.9, 'min_gap': 0.05, 'gap': 1.1, 'accepted': True, 'source': 'base'}
- Preço do KNRI11 hoje: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['cap rate', 'classe processual', 'compra e venda', 'enterprise value', 'mes a mes', 'patrimonio liquido', 'por mes', 'preco medio', 'processo numero', 'publico alvo', 'quantidade processos', 'razao social', 'tipo de fundo', 'valor da empresa', 'valor de mercado', 'valor patrimonial', 'valor patrimonial cota'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.9, 'min_gap': 0.05, 'gap': 4.4, 'accepted': True, 'source': 'base'}
- Dividendos do KNRI11: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['cap rate', 'classe processual', 'compra e venda', 'enterprise value', 'mes a mes', 'patrimonio liquido', 'por mes', 'preco medio', 'processo numero', 'publico alvo', 'quantidade processos', 'razao social', 'tipo de fundo', 'valor da empresa', 'valor de mercado', 'valor patrimonial', 'valor patrimonial cota'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.9, 'min_gap': 0.15, 'gap': 6.6, 'accepted': True, 'source': 'base'}
- Imóveis do KNRI11: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['cap rate', 'classe processual', 'compra e venda', 'enterprise value', 'mes a mes', 'patrimonio liquido', 'por mes', 'preco medio', 'processo numero', 'publico alvo', 'quantidade processos', 'razao social', 'tipo de fundo', 'valor da empresa', 'valor de mercado', 'valor patrimonial', 'valor patrimonial cota'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.85, 'min_gap': 0.1, 'gap': 7.699999999999999, 'accepted': True, 'source': 'base'}
- Notícias do KNRI11: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['cap rate', 'classe processual', 'compra e venda', 'enterprise value', 'mes a mes', 'patrimonio liquido', 'por mes', 'preco medio', 'processo numero', 'publico alvo', 'quantidade processos', 'razao social', 'tipo de fundo', 'valor da empresa', 'valor de mercado', 'valor patrimonial', 'valor patrimonial cota'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.8, 'min_gap': 0.1, 'gap': 4.4, 'accepted': True, 'source': 'base'}
- Como está hoje?: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['cap rate', 'classe processual', 'compra e venda', 'enterprise value', 'mes a mes', 'patrimonio liquido', 'por mes', 'preco medio', 'processo numero', 'publico alvo', 'quantidade processos', 'razao social', 'tipo de fundo', 'valor da empresa', 'valor de mercado', 'valor patrimonial', 'valor patrimonial cota'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.9, 'min_gap': 0.05, 'gap': 0.0, 'accepted': False, 'source': 'base'}
- Quais são os melhores FIIs no ranking?: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['cap rate', 'classe processual', 'compra e venda', 'enterprise value', 'mes a mes', 'patrimonio liquido', 'por mes', 'preco medio', 'processo numero', 'publico alvo', 'quantidade processos', 'razao social', 'tipo de fundo', 'valor da empresa', 'valor de mercado', 'valor patrimonial', 'valor patrimonial cota'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 1.0, 'min_gap': 0.2, 'gap': 5.5, 'accepted': True, 'source': 'base'}
- Qual foi o valor do IPCA em março de 2025?: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['cap rate', 'classe processual', 'compra e venda', 'enterprise value', 'mes a mes', 'patrimonio liquido', 'por mes', 'preco medio', 'processo numero', 'publico alvo', 'quantidade processos', 'razao social', 'tipo de fundo', 'valor da empresa', 'valor de mercado', 'valor patrimonial', 'valor patrimonial cota'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.8, 'min_gap': 0.1, 'gap': 1.1, 'accepted': True, 'source': 'base'}
- Como está KNRI agora?: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['cap rate', 'classe processual', 'compra e venda', 'enterprise value', 'mes a mes', 'patrimonio liquido', 'por mes', 'preco medio', 'processo numero', 'publico alvo', 'quantidade processos', 'razao social', 'tipo de fundo', 'valor da empresa', 'valor de mercado', 'valor patrimonial', 'valor patrimonial cota'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.9, 'min_gap': 0.05, 'gap': 1.1, 'accepted': True, 'source': 'base'}
- Dividendos de XPLG: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['cap rate', 'classe processual', 'compra e venda', 'enterprise value', 'mes a mes', 'patrimonio liquido', 'por mes', 'preco medio', 'processo numero', 'publico alvo', 'quantidade processos', 'razao social', 'tipo de fundo', 'valor da empresa', 'valor de mercado', 'valor patrimonial', 'valor patrimonial cota'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.9, 'min_gap': 0.05, 'gap': -1.1, 'accepted': False, 'source': 'base'}

## Hipóteses confirmadas/refutadas
- Regex-like tokens ou tokens multi-palavra marcados como suspeitos (match literal pode falhar).
- Multi-ticker pode ser reduzido a booleano/1 ticker quando resolve_ticker_from_text retorna apenas o primeiro.

## Próximos passos seguros (somente recomendações)
- Revisar tokens include com caracteres de regex ou espaços (substituir por tokens atômicos).
- Avaliar suporte explícito a múltiplos tickers no Planner (mantendo score).
- Revisar regras de bucket para entidades esperadas que estejam sendo filtradas.