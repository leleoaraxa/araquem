# 1. Arquitetura Geral do Araquem
- **Pipeline**: o endpoint `/ask` aciona o **Orchestrator** para extrair identificadores e construir SQL; o **Planner** avalia intents e entidades com normalização/tokenização, aplica fusão com RAG e thresholds; o **Builder** gera SELECT determinístico a partir dos contratos YAML; o **Executor** (Postgres) executa a query com tracing/metrics; o **Formatter** aplica formatação declarativa e templates; o **Presenter** consolida facts, baseline determinístico e Narrator; o **Narrator** (opcional) decide uso de LLM ou modo determinístico; o retorno inclui meta e answer para o cliente.【F:app/api/ask.py†L38-L178】【F:app/orchestrator/routing.py†L90-L225】【F:app/builder/sql_builder.py†L1-L197】【F:app/executor/pg.py†L10-L52】【F:app/formatter/rows.py†L1-L118】【F:app/presenter/presenter.py†L19-L285】
- **Explain-mode**: o Planner sempre monta `decision_path` (tokenize→rank→route) com `signals` (token/phrase/anti_hits, weights), `fusion` e `rag` (hints, re-rank, context). `thresholds_applied` registra min_score/min_gap/gap/source/accepted. Quando `/ask?explain=true` ativa, as métricas de explain são emitidas e o payload é persistido em `explain_events` com `request_id`.【F:app/planner/planner.py†L98-L358】【F:app/api/ask.py†L48-L114】【F:app/orchestrator/routing.py†L400-L475】
- **RAG/decision signals**: fusão linear/re-rank combina score base e hints de entidades (`fusion.weight`, `rag_signal`, `combined`). `rag_context` guarda snippets filtrados por tokens do intent vencedor e é anexado ao explain e ao Presenter/Narrator. thresholds podem operar em score base ou final (`apply_on`).【F:app/planner/planner.py†L187-L358】【F:app/presenter/presenter.py†L185-L285】
- **Observabilidade**: runtime inicializa OTEL (OTLP gRPC), Prometheus exporters e schemas canônicos. Métricas cobrem HTTP, Planner, cache, SQL, RAG, Narrator e quality. Traces incluem atributos de rota/SQL/request_id; explain usa `trace_id` como `request_id`. Grafana/Prometheus/Tempo são previstos via configs em `data/ops/observability.yaml` e docker-compose stack (Prometheus, Grafana, Tempo, OTEL collector).【F:app/observability/runtime.py†L15-L118】【F:app/observability/metrics.py†L1-L112】【F:docker-compose.yml†L1-L90】

# 2. Estado Atual dos Módulos
## 2.1 Planner
- **Intent scoring**: normaliza (lower/strip_accents/strip_punct), tokeniza por `\b`, soma pesos para tokens/phrases include e penaliza excludes/anti_tokens. Mantém `details` por intent e `weights_summary`.【F:app/planner/planner.py†L65-L186】
- **Thresholds reais**: `_load_thresholds` lê `data/ops/planner_thresholds.yaml` (defaults min_score=1.0, min_gap=0.5, apply_on base; per-intent/entity overrides). Gate avalia `score_for_gate` e `gap` (base ou final se re-rank). `chosen.accepted` expõe resultado.【F:app/planner/planner.py†L20-L58】【F:app/planner/planner.py†L320-L358】
- **RAG fusion**: controla via YAML (`planner.rag`). Se habilitado, busca embeddings, gera `entity_hints` e funde scores (blend/additive) com peso `rag_weight` ou `re_rank.weight`. Blocos `fusion`, `scoring.final_combined`, `rag_signal` e `rag_hint` expõem números.【F:app/planner/planner.py†L187-L318】
- **Explain data model**: `explain` inclui `signals`, `decision_path`, `scoring` (intent/entity, gaps base/final, combined, thresholds_applied, rag_signal/hint), `rag` (config/usage), `rag_context` (doc/snippets/reason), `fusion` (enabled/used/weight/mode/affected/error). `/ask?explain=true` também registra analytics com `planner_output` e métricas de latência/cache.【F:app/planner/planner.py†L187-L358】【F:app/api/ask.py†L48-L114】

## 2.2 RAG
- **context_builder**: `build_context` aplica política `data/policies/rag.yaml` (routing.allow_intents/deny_intents, entities/default/profiles). Resolve collections, max_chunks/min_score/max_tokens, usa embeddings search determinístico e normaliza chunks (texto, score, doc_id, collection). Desabilita quando não permitido ou erro, retornando `enabled=False` e motivo.【F:app/rag/context_builder.py†L1-L179】【F:data/policies/rag.yaml†L1-L68】
- **entity_hints**: Planner lê store via `cached_embedding_store`, gera vetor com `OllamaClient.embed` e converte resultados em hints por entidade (`entity_hints_from_rag`).【F:app/planner/planner.py†L187-L230】
- **RAG fusion & re-ranking**: peso definido em policy (`rag.weight` ou `re_rank.weight`); modos blend/additive ajustam score final; `fusion` bloco aponta `affected_entities` e erro. Re-rank flag controla se thresholds usam score final.【F:app/planner/planner.py†L240-L320】
- **Re-ranking**: configurável em `planner.rag.re_rank` (enable/mode/weight); aplicado na fusão; métricas `planner_rerank_applied_total` e gaps before/after coletadas.【F:app/planner/planner.py†L240-L358】
- **Políticas**: `data/policies/rag.yaml` define profiles (default/macro/risk), roteamento por intent, collections por entidade e default seguro (concepts-fiis).【F:data/policies/rag.yaml†L1-L80】

## 2.3 Formatter
- **Responsabilidade**: `render_rows_template` carrega `entity.yaml`→presentation.kind→template Jinja em `responses/{kind}.md.j2`, com campos key/value e empty_message. Protege path e falhas retornam string vazia.【F:app/formatter/rows.py†L1-L89】
- **Rows/Aggregates/Meta**: `format_rows` mantém colunas declaradas, aplica formatação decimal/data/percent/currency e métricas (`metric_key` em meta). Meta agregada fica em `aggregates` do orchestrator/presenter; requested_metrics lidas via ontology ask config.【F:app/formatter/rows.py†L90-L118】【F:app/orchestrator/routing.py†L280-L332】

## 2.4 Presenter
- **FactsPayload**: estrutura canônica com question/intent/entity/score/result_key/rows/primary/aggregates/identifiers/requested_metrics/ticker/fund e planner_score.【F:app/presenter/presenter.py†L19-L157】
- **PresentResult**: inclui answer, legacy_answer, rendered_template, narrator_meta, facts.【F:app/presenter/presenter.py†L59-L80】
- **Workflow determinístico**: sempre constrói facts, renderiza baseline determinístico via `render_answer` e `render_rows_template`, monta narrator_info (enabled/shadow/model/latency/error/used/strategy) e final_answer inicia como baseline.【F:app/presenter/presenter.py†L162-L226】
- **narrator_shadow/fallback/baseline/template**: quando Narrator retorna strategy `llm_shadow`, mantém baseline; erros retornam baseline com strategy `fallback_error`; template renderizado é retornado em PresentResult junto ao baseline.【F:app/presenter/presenter.py†L240-L285】
- **render_rows_template integração**: chamada após legacy_answer para gerar Markdown tabular conforme entity presentation; resultado exposto em `rendered_template`.【F:app/presenter/presenter.py†L204-L212】
- **render_answer integração**: baseline textual determinístico sempre computado e usado em fallback/shadow.【F:app/presenter/presenter.py†L204-L266】
- **narrator_meta e estratégias**: narrator_info captura flags, latência, erro e estratégia final (`fallback`, `llm`, `llm_shadow`, `fallback_error`). Métricas de latência e render são emitidas. `narrator_rag_context` é passado e persistido em narrator_meta.【F:app/presenter/presenter.py†L185-L285】

## 2.5 Narrator
- **narrator.yaml**: carregado via `data/policies/narrator.yaml` (default/entidades, llm_enabled/shadow/model/max_llm_rows/use_rag_in_prompt etc.). Effective policy combina default + overrides, ignorando env para habilitação/shadow.【F:app/narrator/narrator.py†L85-L160】
- **Política de LLM**: `_should_use_llm` checa policy enabled e limites de linhas; render retorna baseline se desabilitado ou max_llm_rows <=0 ou rows>limite ou client indisponível. Tokens/latency/strategy registrados.【F:app/narrator/narrator.py†L121-L212】【F:app/narrator/narrator.py†L360-L460】
- **Shadow mode**: se `shadow=True`, estratégia final `llm_shadow` devolve baseline mas registra uso; Narrator_meta marca enabled/shadow/model/strategy e rag_ctx. LLM errors caem em `llm_failed` com baseline.【F:app/narrator/narrator.py†L360-L520】
- **Integração com Presenter**: Presenter passa facts/meta (inclui explain, result_key, rag_context). Narrator decide concept_mode, rag_usage e fallback; responde com texto/strategy/meta que o Presenter usa para final_answer e métricas.【F:app/presenter/presenter.py†L226-L285】【F:app/narrator/narrator.py†L190-L360】

## 2.6 Executor
- **SQL executor real**: `PgExecutor.query` usa psycopg, sanitiza SQL para tracing, abre trace span `executor.sql.execute`, seta atributos db.system/name/table/statement, executa com params e retorna dict rows. Emite métricas de duração e rows retornados; erros incrementam `sirios_sql_errors_total`. Usa DATABASE_URL.【F:app/executor/pg.py†L10-L52】
- **Views/Materialized views**: builder lê `entity.yaml` (`sql_view`, `result_key`, `columns`) e gera SELECT. Suporta métricas (UNION de SQLs), agregações (avg/sum/list/latest), filtros de período/default_date_field, multi-ticker e window months/count. Materialized views seguem `sql_view` declarado nos contratos (não há geração dinâmica).【F:app/builder/sql_builder.py†L1-L332】【F:app/builder/sql_builder.py†L332-L520】
- **Parâmetros inferidos**: infer_params fornece `agg_params` (agg/order/window/metric/limit/period); builder injeta em SQL (placeholders, window filters, metrics). Orchestrator normaliza janela e usa para cache key.【F:app/orchestrator/routing.py†L250-L332】【F:app/builder/sql_builder.py†L180-L332】

## 2.7 Observability
- **Métricas existentes**: catálogo inclui HTTP, planner (routed, explain, gaps, thresholds), cache, SQL, RAG (search/hits/context/re-rank), Narrator, explain persistence, quality. Facade valida labels e exporta via Prometheus client.【F:app/observability/metrics.py†L1-L112】【F:app/observability/runtime.py†L70-L152】
- **Counters/Histograms**: `emit_counter/emit_histogram/emit_gauge` normalizam labels; buckets padrão ms; exemplos: `sirios_planner_route_decisions_total`, `planner_rag_context_latency_ms`, `sirios_narrator_latency_ms`.【F:app/observability/metrics.py†L1-L112】【F:app/observability/runtime.py†L70-L152】
- **request_id/tracing**: `/ask` gera `request_id`; explain analytics usa `trace_id` do span. Tracing OTEL inicializado com OTLP exporter; spans para planner.route e executor.sql.execute incluem atributos de rota/cache/SQL.【F:app/api/ask.py†L38-L178】【F:app/orchestrator/routing.py†L330-L420】【F:app/executor/pg.py†L18-L52】【F:app/observability/runtime.py†L31-L90】
- **Integração OTEL**: `init_tracing` configura TracerProvider e BatchSpanProcessor para OTLP; docker-compose traz Tempo e otel-collector para backend de traces; Grafana dashboards previstos para quality e observability.【F:app/observability/runtime.py†L15-L90】【F:docker-compose.yml†L1-L90】【F:grafana/provisioning/dashboards/quality_dashboard.json†L1-L80】

# 3. Entidades
- **FIIs**: fiis_cadastro, fiis_precos, fiis_dividendos, fiis_imoveis, fiis_rankings, fiis_processos, fiis_financials_snapshot, fiis_financials_revenue_schedule, fiis_financials_risk, fiis_noticias.【F:data/entities†L1-L4】
- **fiis_precos (histórica)**: série diária multi-ticker (open/close/adj_close/max/min/daily_variation_pct) com `default_date_field: traded_at`, janelas months 3/6/12/24 para histórico; param_inference ajustado para mapear "últimos X meses/anos" e separar latest/list; qualidade atualizada para variações diárias realistas; RAG negado (100% SQL) e Narrator determinístico.
- **fiis_dividendos (histórica)**: série histórica de proventos por FII (`dividend_amt`, `payment_date`, `traded_until_date`, `default_date_field: payment_date`), multi-ticker e mensal. Param_inference ajustado para usar `months:12` como janela padrão (histórico de 12 meses) com palavras-chave para "últimos X meses/eventos"; RAG negado (SQL-only) e Narrator determinístico.
- **fiis_financials_snapshot (snapshot D-1)**: foto diária por FII de métricas financeiras (DY mensal/12m, payout, P/VP, market cap, cap rate, alavancagem, caixa/passivos, patrimônio etc.), com `default_date_field: updated_at` e ordenação por `ticker, last_payment_date DESC`. 1 linha por ticker (~415 FIIs), sem histórico; RAG negado (métricas 100% SQL) e Narrator determinístico.
- **Históricas**: history_b3_indexes, history_currency_rates, history_market_indicators.【F:data/entities†L1-L4】
- **Cliente**: client_fiis_positions.【F:data/entities†L1-L2】
- **Contratos+tolerances**: cada entidade tem contrato YAML com columns/result_key/sql_view/identifiers/order/aggregations/metrics e bloco `tolerance` (extra_columns_allowed, missing_columns_allowed, nullable_mismatch_warn_only). Exemplo fiis_cadastro marca false para extras/missing/nullable, enforce estrito.【F:data/contracts/entities/fiis_cadastro.schema.yaml†L1-L86】
- **Correções recentes**: `fiis_financials_revenue_schedule` é snapshot D-1 sem histórico; janelas temporais removidas de `entity.yaml`/`param_inference.yaml` e bloco RAG da entidade eliminado mantendo intent negado para RAG.

# 4. Ontologia
- **Estrutura**: `data/ontology/entity.yaml` define normalize (lower/strip_accents/strip_punct), token_split `\b`, weights token/phrase e intents com tokens/phrases include/exclude, anti_tokens e entities associadas.【F:data/ontology/entity.yaml†L1-L120】
- **Synonyms/metrics_synonyms**: routing extrai métricas solicitadas comparando `ask.metrics_synonyms` de cada `entity.yaml` com pergunta normalizada; identifica métricas para formatter/presenter. (Mapa dentro de cada entidade via chave ask.metrics_synonyms).【F:app/orchestrator/routing.py†L30-L70】【F:app/orchestrator/routing.py†L470-L520】
- **Influência no routing**: planner usa intents do ontology para scoring e associação de entidades; normalização e tokenização controlam sensibilidade; anti_tokens penalizam. `extract_requested_metrics` usa synonyms para meta.requested_metrics, influenciando Narrator e formatação.【F:app/planner/planner.py†L98-L186】【F:app/orchestrator/routing.py†L30-L90】【F:app/presenter/presenter.py†L19-L157】
- **Interação RAG**: intents vencedores orientam filtros de snippets (tokens include) em `rag_context`, garantindo relevância semântica ao contextualizar Presenter/Narrator.【F:app/planner/planner.py†L300-L358】
- **Notas de intents para FIIs**: tokens de indicadores financeiros (payout, alavancagem, market cap, price book/PVP, DY/dy12m quando não forem ranking) resolvem via `fiis_financials_snapshot`; histórico de dividendos (`dividend_amt`) permanece em `fiis_dividendos`; rankings/comparações globais usam entidades como `fiis_rankings` conforme já descrito.
- **Notas de dividendos**: tokens de DY/yield foram removidos da intent `fiis_dividendos` (entidade só expõe dividend_amt); roteamento de yield permanece nos intents apropriados (ex.: rankings).

# 5. Explain Mode
- **Logs/payload**: `plan['explain']` contém `signals` (token_scores, phrase_scores, anti_hits, normalizations, weights_summary), `decision_path`, `scoring` (intent/entity, gaps base/final, combined/final_combined, rag_signal, rag_hint, thresholds_applied), `rag` (config/used/error), `fusion`, `rag_context` (doc/snippets/reason). `/ask?explain=true` adiciona `explain_analytics` com route_id/view/cache info e persiste em `explain_events` (intent/entity/route_id/sql_view/sql_hash/cache_policy/latency).【F:app/planner/planner.py†L187-L358】【F:app/api/ask.py†L48-L114】
- **Exemplo (reduzido)**: `decision_path`=[{stage:tokenize,value:<norm>,result:[...]},{stage:rank,type:intent_scoring,intent:<name>,score:<x>},{stage:route,type:entity_select,entity:<ent>,score_after:<x>}]; `thresholds_applied`={min_score:1.0,min_gap:0.5,gap:top2_gap,accepted:true,source:base}; `rag_context`={top_doc:<id>,snippets:[...],reason:"Contexto cita tokens..."}.【F:app/planner/planner.py†L98-L358】

# 6. Quality
- **quality_list_misses.py**: wrapper que chama `quality_diff_routing.py` para listar perguntas que falham nos quality gates comparando samples routing; usa arquivo `data/ops/quality/routing_samples.json` e grava misses em `data/ops/quality_experimental/routing_misses_via_ask.json`.【F:scripts/quality/quality_list_misses.py†L1-L40】
- **quality_push**: endpoint `/ops/quality/push` recebe payloads de amostras de roteamento, valida policy e registra métricas; scripts `quality_push.py` e `quality_push_cron.py` automatizam envio e verificações com tokens e quality gates. Dashboards Grafana gerados por `gen_quality_dashboard.py`.【F:app/api/ops/quality.py†L148-L420】【F:scripts/quality/quality_push.py†L1-L90】【F:scripts/quality/gen_quality_dashboard.py†L1-L160】
- **Baseline**: quality_report utiliza policy `data/policies/quality.yaml` ou fallback e expõe métricas de top1/gap/routed; scripts shell `quality_gate_check.sh` consultam API/Prometheus. Baseline determinístico do Presenter/Narrator garante comparação consistente em shadow/llm. Prometheus coleta métricas `sirios_planner_top1_match_total`, `planner_quality_*`.【F:app/api/ops/quality.py†L480-L563】【F:app/observability/runtime.py†L70-L152】【F:app/presenter/presenter.py†L204-L285】

# 7. Caminho para Produção
- **Pronto**: pipeline end-to-end operando via `/ask` com Planner/RAG opcional, Builder/Executor SQL, cache de métricas, explain analytics, Presenter+Narrator (determinístico/LLM), observabilidade Prometheus/OTEL, políticas declarativas para RAG/Narrator/Cache/Quality, contratos YAML e schemas de dados, scripts de quality e dashboards. Docker-compose inclui Grafana/Prometheus/Tempo/otel-collector/postgres/redis.【F:app/api/ask.py†L38-L178】【F:app/orchestrator/routing.py†L90-L475】【F:app/presenter/presenter.py†L19-L285】【F:docker-compose.yml†L1-L90】
- **Faltam**: configurar conteúdo efetivo dos índices RAG (embeddings store) e políticas específicas por entidade onde não definidas; completar `data/policies/narrator.yaml` para habilitar LLM em produção; ajustar thresholds em `planner_thresholds.yaml` conforme métricas reais; provisionar credenciais/URLs reais para DATABASE_URL/OTEL/Prometheus; validar quality gates com datasets atualizados e executar scripts de push/cron em ambiente alvo.【F:app/planner/planner.py†L20-L58】【F:app/rag/context_builder.py†L1-L179】【F:app/narrator/narrator.py†L85-L160】【F:scripts/quality/quality_push_cron.py†L1-L180】

# 8. Anexos
- app/api/ask.py – pipeline `/ask`, explain analytics, Narrator logging.【F:app/api/ask.py†L38-L178】
- app/planner/planner.py – scoring, RAG fusion, explain, thresholds.【F:app/planner/planner.py†L98-L358】
- app/rag/context_builder.py – políticas de RAG, build_context determinístico.【F:app/rag/context_builder.py†L1-L179】
- app/presenter/presenter.py – FactsPayload, PresentResult, shadow/baseline/template, Narrator integração.【F:app/presenter/presenter.py†L19-L285】
- app/narrator/narrator.py – política LLM/shadow, prompt builder, fallback e uso de RAG no prompt.【F:app/narrator/narrator.py†L85-L520】
- app/formatter/rows.py – formatação/tabular templates e métricas.【F:app/formatter/rows.py†L1-L118】
- data/policies – rag.yaml, narrator.yaml (políticas declarativas), quality.yaml (gates).【F:data/policies/rag.yaml†L1-L80】【F:app/narrator/narrator.py†L85-L160】【F:app/api/ops/quality.py†L480-L563】
- data/entities – contratos de entidades e presentations usados por Builder/Formatter/Narrator.【F:data/entities†L1-L4】【F:data/contracts/entities/fiis_cadastro.schema.yaml†L1-L86】
