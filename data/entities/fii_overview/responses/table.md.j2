{% set rows = rows if rows is defined else [] %}
{# Só hidrata rows via results se rows estiver vazio (rewrite_only-safe) #}
{% if (not rows) and results is defined and meta is defined and meta.result_key is defined and (meta.result_key in results) %}
  {% set rows = results[meta.result_key] %}
{% endif %}

{% if rows and rows|length > 0 -%}
  {# IMPORTANTE: groupby exige ordenação prévia para não quebrar grupos #}
  {% set rows_sorted = rows | sort(attribute='ticker') %}
  {% set grouped = rows_sorted | groupby('ticker') %}

  {% for ticker, items in grouped %}
    {% set r = items[0] %}
### Overview do {{ r.ticker or '-' }}

- Nome: **{{ r.display_name or r.b3_name or '-' }}**
- Classificação e gestão: **{{ r.classification or '-' }} / {{ r.management_type or '-' }}**
- Setor e subsetor: **{{ r.sector or '-' }} / {{ r.sub_sector or '-' }}**
- DY mensal / 12m: **{{ r.dy_monthly_pct if r.dy_monthly_pct is not none else '-' }} / {{ r.dy_12m_pct if r.dy_12m_pct is not none else '-' }}**

| Código | Nome | Classificação | Setor | Subsetor | Tipo de gestão | DY mensal (%) | DY 12m (%) | Último dividendo (R$) | Último pagamento | Valor de mercado (R$) | Atualizado em |
| --- | --- | --- | --- | --- | --- | ---: | ---: | ---: | --- | ---: | --- |
{% for r in items %}
  {% set updated_val = r.snapshot_updated_at if r.snapshot_updated_at is not none else r.updated_at %}
| {{ r.ticker or '-' }} | {{ r.display_name or r.b3_name or '-' }} | {{ r.classification or '-' }} | {{ r.sector or '-' }} | {{ r.sub_sector or '-' }} | {{ r.management_type or '-' }} | {{ r.dy_monthly_pct if r.dy_monthly_pct is not none else '-' }} | {{ r.dy_12m_pct if r.dy_12m_pct is not none else '-' }} | {{ r.last_dividend_amt if r.last_dividend_amt is not none else '-' }} | {{ r.last_payment_date if r.last_payment_date is not none else '-' }} | {{ r.market_cap_value if r.market_cap_value is not none else '-' }} | {{ updated_val if updated_val is not none else '-' }} |
{% endfor %}

**Detalhes**

| Código | Mercado-alvo | Exclusivo | Dividendos 12m (R$) | P/BV | PL por cota (R$) | Receita por cota | Payout (%) | Taxa de crescimento | Cap rate | Alavancagem | Patrimônio líquido (R$) | Nº de cotas | Nº de cotistas | Variação mês (%) | Variação ano (%) | Volatilidade | Sharpe | Sortino | Máx. drawdown | Peso IFIX (%) | Peso IFIL (%) | Rank usuários | Rank Sírios | Rank IFIX | Rank IFIL | Rank DY 12m | Rank DY mensal | Rank dividendos 12m | Rank valor de mercado | Rank patrimônio líquido | Snapshot criado em | Indicadores de risco criados em | Indicadores de risco atualizados em | Rankings atualizados em |
| --- | --- | --- | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: | --- | --- | --- | --- |
{% for r in items %}
| {{ r.ticker or '-' }} | {{ r.target_market or '-' }} | {{ 'Sim' if r.is_exclusive else 'Não' if r.is_exclusive is not none else '-' }} | {{ r.dividends_12m_amt if r.dividends_12m_amt is not none else '-' }} | {{ r.price_book_ratio if r.price_book_ratio is not none else '-' }} | {{ r.equity_per_share if r.equity_per_share is not none else '-' }} | {{ r.revenue_per_share if r.revenue_per_share is not none else '-' }} | {{ r.dividend_payout_pct if r.dividend_payout_pct is not none else '-' }} | {{ r.growth_rate if r.growth_rate is not none else '-' }} | {{ r.cap_rate if r.cap_rate is not none else '-' }} | {{ r.leverage_ratio if r.leverage_ratio is not none else '-' }} | {{ r.equity_value if r.equity_value is not none else '-' }} | {{ r.shares_count if r.shares_count is not none else '-' }} | {{ r.shareholders_count if r.shareholders_count is not none else '-' }} | {{ r.variation_month_ratio if r.variation_month_ratio is not none else '-' }} | {{ r.variation_year_ratio if r.variation_year_ratio is not none else '-' }} | {{ r.volatility_ratio if r.volatility_ratio is not none else '-' }} | {{ r.sharpe_ratio if r.sharpe_ratio is not none else '-' }} | {{ r.sortino_ratio if r.sortino_ratio is not none else '-' }} | {{ r.max_drawdown if r.max_drawdown is not none else '-' }} | {{ r.ifix_weight_pct if r.ifix_weight_pct is not none else '-' }} | {{ r.ifil_weight_pct if r.ifil_weight_pct is not none else '-' }} | {{ r.users_rank_position if r.users_rank_position is not none else '-' }} | {{ r.sirios_rank_position if r.sirios_rank_position is not none else '-' }} | {{ r.ifix_rank_position if r.ifix_rank_position is not none else '-' }} | {{ r.ifil_rank_position if r.ifil_rank_position is not none else '-' }} | {{ r.rank_dy_12m if r.rank_dy_12m is not none else '-' }} | {{ r.rank_dy_monthly if r.rank_dy_monthly is not none else '-' }} | {{ r.rank_dividends_12m if r.rank_dividends_12m is not none else '-' }} | {{ r.rank_market_cap if r.rank_market_cap is not none else '-' }} | {{ r.rank_equity if r.rank_equity is not none else '-' }} | {{ r.snapshot_created_at if r.snapshot_created_at is not none else '-' }} | {{ r.risk_created_at if r.risk_created_at is not none else '-' }} | {{ r.risk_updated_at if r.risk_updated_at is not none else '-' }} | {{ r.rankings_updated_at if r.rankings_updated_at is not none else '-' }} |
{% endfor %}

{% if not loop.last %}

---

{% endif %}
  {% endfor %}
{%- else -%}
  {{ empty_message or "Nenhum registro encontrado." }}
{%- endif %}
