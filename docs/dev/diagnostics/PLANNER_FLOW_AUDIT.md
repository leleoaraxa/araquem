# Auditoria do Planner (roteamento single vs multi ticker)

## Fluxo real do Planner
- Normalização/tokenização conforme ontologia (steps e regex de split).
- Extração de ticker via ticker_index (exact/prefix4) sem alterar score.
- Bucket via data/ontology/bucket_rules.yaml seguido de filtro de entidades.
- Scoring base por tokens/phrases + anti-penalty, fusão opcional com RAG, e gate por thresholds.

## Casos com 1 ticker vs multi ticker
- **Como está KNRI11 e XPLG11?** — tickers: ['KNRI11', 'XPLG11'] → chosen: ticker_query / fiis_precos (accepted=True)
- **Preço do KNRI11 e do XPLG11 hoje** — tickers: ['KNRI11', 'XPLG11'] → chosen: fiis_precos / fiis_precos (accepted=True)
- **Dividendos de KNRI11 e XPLG11** — tickers: ['KNRI11', 'XPLG11'] → chosen: ticker_query / fiis_registrations (accepted=False)
- **Quais são os imóveis do KNRI11 e XPLG11?** — tickers: ['KNRI11', 'XPLG11'] → chosen: fiis_real_estate / fiis_real_estate (accepted=True)
- **Tem notícias do KNRI11 e do XPLG11?** — tickers: ['KNRI11', 'XPLG11'] → chosen: fiis_news / fiis_news (accepted=True)
- **Como está KNRI11 agora?** — tickers: ['KNRI11'] → chosen: ticker_query / fiis_dividends (accepted=False)
- **Preço do KNRI11 hoje** — tickers: ['KNRI11'] → chosen: fiis_precos / fiis_precos (accepted=True)
- **Dividendos do KNRI11** — tickers: ['KNRI11'] → chosen: fiis_dividends / fiis_dividends (accepted=True)
- **Imóveis do KNRI11** — tickers: ['KNRI11'] → chosen: fiis_real_estate / fiis_real_estate (accepted=True)
- **Notícias do KNRI11** — tickers: ['KNRI11'] → chosen: fiis_news / fiis_news (accepted=True)
- **Como está hoje?** — tickers: [] → chosen: fiis_precos / fiis_precos (accepted=True)
- **Quais são os melhores FIIs no ranking?** — tickers: [] → chosen: fiis_rankings / fiis_rankings (accepted=True)
- **Qual foi o valor do IPCA em março de 2025?** — tickers: [] → chosen: history_market_indicators / history_market_indicators (accepted=True)
- **Como está KNRI agora?** — tickers: ['KNRI11'] → chosen: ticker_query / fiis_dividends (accepted=False)
- **Dividendos de XPLG** — tickers: ['XPLG11'] → chosen: ticker_query / fiis_registrations (accepted=False)

## Onde falha e por quê (com evidência)
- Como está KNRI11 e XPLG11?: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['0 3m', '12 18m', '12 meses', '18 24m', '24 30m', '24 meses', '3 6m', '30 36m', '6 12m', 'abertura do dia', 'acima 36m', 'ambiente de inflacao', 'ambiente de juros', 'ambiente macro', 'ao longo dos anos', 'cada mes', 'caixa disponivel', 'carteira de fiis', 'cenario macro', 'cenario macro atual', 'cenario macro para fiis', 'centro comercial', 'cnpj do', 'cnpj do administrador', 'como esta na b3', 'como fiis reagem', 'como foi a performance da minha carteira de fiis versus o ifix nos ultimos 12 meses', 'comparacao de dividendos', 'comparar com cdi', 'comparar com ibov'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.9, 'min_gap': 0.0, 'gap': 1.0143384861561107, 'accepted': True, 'source': 'final'}
- Preço do KNRI11 e do XPLG11 hoje: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['0 3m', '12 18m', '12 meses', '18 24m', '24 30m', '24 meses', '3 6m', '30 36m', '6 12m', 'abertura do dia', 'acima 36m', 'ambiente de inflacao', 'ambiente de juros', 'ambiente macro', 'ao longo dos anos', 'cada mes', 'caixa disponivel', 'carteira de fiis', 'cenario macro', 'cenario macro atual', 'cenario macro para fiis', 'centro comercial', 'cnpj do', 'cnpj do administrador', 'como esta na b3', 'como fiis reagem', 'como foi a performance da minha carteira de fiis versus o ifix nos ultimos 12 meses', 'comparacao de dividendos', 'comparar com cdi', 'comparar com ibov'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.9, 'min_gap': 0.0, 'gap': 4.391672374386557, 'accepted': True, 'source': 'final'}
- Dividendos de KNRI11 e XPLG11: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['0 3m', '12 18m', '12 meses', '18 24m', '24 30m', '24 meses', '3 6m', '30 36m', '6 12m', 'abertura do dia', 'acima 36m', 'ambiente de inflacao', 'ambiente de juros', 'ambiente macro', 'ao longo dos anos', 'cada mes', 'caixa disponivel', 'carteira de fiis', 'cenario macro', 'cenario macro atual', 'cenario macro para fiis', 'centro comercial', 'cnpj do', 'cnpj do administrador', 'como esta na b3', 'como fiis reagem', 'como foi a performance da minha carteira de fiis versus o ifix nos ultimos 12 meses', 'comparacao de dividendos', 'comparar com cdi', 'comparar com ibov'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 1.0, 'min_gap': 0.2, 'gap': 0.09189937447598204, 'accepted': False, 'source': 'final'}
- Quais são os imóveis do KNRI11 e XPLG11?: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['0 3m', '12 18m', '12 meses', '18 24m', '24 30m', '24 meses', '3 6m', '30 36m', '6 12m', 'abertura do dia', 'acima 36m', 'ambiente de inflacao', 'ambiente de juros', 'ambiente macro', 'ao longo dos anos', 'cada mes', 'caixa disponivel', 'carteira de fiis', 'cenario macro', 'cenario macro atual', 'cenario macro para fiis', 'centro comercial', 'cnpj do', 'cnpj do administrador', 'como esta na b3', 'como fiis reagem', 'como foi a performance da minha carteira de fiis versus o ifix nos ultimos 12 meses', 'comparacao de dividendos', 'comparar com cdi', 'comparar com ibov'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.85, 'min_gap': 0.1, 'gap': 6.6, 'accepted': True, 'source': 'final'}
- Tem notícias do KNRI11 e do XPLG11?: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['0 3m', '12 18m', '12 meses', '18 24m', '24 30m', '24 meses', '3 6m', '30 36m', '6 12m', 'abertura do dia', 'acima 36m', 'ambiente de inflacao', 'ambiente de juros', 'ambiente macro', 'ao longo dos anos', 'cada mes', 'caixa disponivel', 'carteira de fiis', 'cenario macro', 'cenario macro atual', 'cenario macro para fiis', 'centro comercial', 'cnpj do', 'cnpj do administrador', 'como esta na b3', 'como fiis reagem', 'como foi a performance da minha carteira de fiis versus o ifix nos ultimos 12 meses', 'comparacao de dividendos', 'comparar com cdi', 'comparar com ibov'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.8, 'min_gap': 0.1, 'gap': 3.21277404912887, 'accepted': True, 'source': 'final'}
- Como está KNRI11 agora?: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['0 3m', '12 18m', '12 meses', '18 24m', '24 30m', '24 meses', '3 6m', '30 36m', '6 12m', 'abertura do dia', 'acima 36m', 'ambiente de inflacao', 'ambiente de juros', 'ambiente macro', 'ao longo dos anos', 'cada mes', 'caixa disponivel', 'carteira de fiis', 'cenario macro', 'cenario macro atual', 'cenario macro para fiis', 'centro comercial', 'cnpj do', 'cnpj do administrador', 'como esta na b3', 'como fiis reagem', 'como foi a performance da minha carteira de fiis versus o ifix nos ultimos 12 meses', 'comparacao de dividendos', 'comparar com cdi', 'comparar com ibov'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.9, 'min_gap': 0.15, 'gap': 0.08693938752272845, 'accepted': False, 'source': 'final'}
- Preço do KNRI11 hoje: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['0 3m', '12 18m', '12 meses', '18 24m', '24 30m', '24 meses', '3 6m', '30 36m', '6 12m', 'abertura do dia', 'acima 36m', 'ambiente de inflacao', 'ambiente de juros', 'ambiente macro', 'ao longo dos anos', 'cada mes', 'caixa disponivel', 'carteira de fiis', 'cenario macro', 'cenario macro atual', 'cenario macro para fiis', 'centro comercial', 'cnpj do', 'cnpj do administrador', 'como esta na b3', 'como fiis reagem', 'como foi a performance da minha carteira de fiis versus o ifix nos ultimos 12 meses', 'comparacao de dividendos', 'comparar com cdi', 'comparar com ibov'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.9, 'min_gap': 0.0, 'gap': 4.399022332807856, 'accepted': True, 'source': 'final'}
- Dividendos do KNRI11: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['0 3m', '12 18m', '12 meses', '18 24m', '24 30m', '24 meses', '3 6m', '30 36m', '6 12m', 'abertura do dia', 'acima 36m', 'ambiente de inflacao', 'ambiente de juros', 'ambiente macro', 'ao longo dos anos', 'cada mes', 'caixa disponivel', 'carteira de fiis', 'cenario macro', 'cenario macro atual', 'cenario macro para fiis', 'centro comercial', 'cnpj do', 'cnpj do administrador', 'como esta na b3', 'como fiis reagem', 'como foi a performance da minha carteira de fiis versus o ifix nos ultimos 12 meses', 'comparacao de dividendos', 'comparar com cdi', 'comparar com ibov'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.9, 'min_gap': 0.15, 'gap': 6.514275220177796, 'accepted': True, 'source': 'final'}
- Imóveis do KNRI11: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['0 3m', '12 18m', '12 meses', '18 24m', '24 30m', '24 meses', '3 6m', '30 36m', '6 12m', 'abertura do dia', 'acima 36m', 'ambiente de inflacao', 'ambiente de juros', 'ambiente macro', 'ao longo dos anos', 'cada mes', 'caixa disponivel', 'carteira de fiis', 'cenario macro', 'cenario macro atual', 'cenario macro para fiis', 'centro comercial', 'cnpj do', 'cnpj do administrador', 'como esta na b3', 'como fiis reagem', 'como foi a performance da minha carteira de fiis versus o ifix nos ultimos 12 meses', 'comparacao de dividendos', 'comparar com cdi', 'comparar com ibov'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.85, 'min_gap': 0.1, 'gap': 6.6, 'accepted': True, 'source': 'final'}
- Notícias do KNRI11: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['0 3m', '12 18m', '12 meses', '18 24m', '24 30m', '24 meses', '3 6m', '30 36m', '6 12m', 'abertura do dia', 'acima 36m', 'ambiente de inflacao', 'ambiente de juros', 'ambiente macro', 'ao longo dos anos', 'cada mes', 'caixa disponivel', 'carteira de fiis', 'cenario macro', 'cenario macro atual', 'cenario macro para fiis', 'centro comercial', 'cnpj do', 'cnpj do administrador', 'como esta na b3', 'como fiis reagem', 'como foi a performance da minha carteira de fiis versus o ifix nos ultimos 12 meses', 'comparacao de dividendos', 'comparar com cdi', 'comparar com ibov'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.8, 'min_gap': 0.1, 'gap': 3.214275220177796, 'accepted': True, 'source': 'final'}
- Como está hoje?: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['0 3m', '12 18m', '12 meses', '18 24m', '24 30m', '24 meses', '3 6m', '30 36m', '6 12m', 'abertura do dia', 'acima 36m', 'ambiente de inflacao', 'ambiente de juros', 'ambiente macro', 'ao longo dos anos', 'cada mes', 'caixa disponivel', 'carteira de fiis', 'cenario macro', 'cenario macro atual', 'cenario macro para fiis', 'centro comercial', 'cnpj do', 'cnpj do administrador', 'como esta na b3', 'como fiis reagem', 'como foi a performance da minha carteira de fiis versus o ifix nos ultimos 12 meses', 'comparacao de dividendos', 'comparar com cdi', 'comparar com ibov'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.9, 'min_gap': 0.0, 'gap': 0.0, 'accepted': True, 'source': 'final'}
- Quais são os melhores FIIs no ranking?: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['0 3m', '12 18m', '12 meses', '18 24m', '24 30m', '24 meses', '3 6m', '30 36m', '6 12m', 'abertura do dia', 'acima 36m', 'ambiente de inflacao', 'ambiente de juros', 'ambiente macro', 'ao longo dos anos', 'cada mes', 'caixa disponivel', 'carteira de fiis', 'cenario macro', 'cenario macro atual', 'cenario macro para fiis', 'centro comercial', 'cnpj do', 'cnpj do administrador', 'como esta na b3', 'como fiis reagem', 'como foi a performance da minha carteira de fiis versus o ifix nos ultimos 12 meses', 'comparacao de dividendos', 'comparar com cdi', 'comparar com ibov'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 1.0, 'min_gap': 0.2, 'gap': 4.675, 'accepted': True, 'source': 'final'}
- Qual foi o valor do IPCA em março de 2025?: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['0 3m', '12 18m', '12 meses', '18 24m', '24 30m', '24 meses', '3 6m', '30 36m', '6 12m', 'abertura do dia', 'acima 36m', 'ambiente de inflacao', 'ambiente de juros', 'ambiente macro', 'ao longo dos anos', 'cada mes', 'caixa disponivel', 'carteira de fiis', 'cenario macro', 'cenario macro atual', 'cenario macro para fiis', 'centro comercial', 'cnpj do', 'cnpj do administrador', 'como esta na b3', 'como fiis reagem', 'como foi a performance da minha carteira de fiis versus o ifix nos ultimos 12 meses', 'comparacao de dividendos', 'comparar com cdi', 'comparar com ibov'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.8, 'min_gap': 0.1, 'gap': 1.1, 'accepted': True, 'source': 'final'}
- Como está KNRI agora?: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['0 3m', '12 18m', '12 meses', '18 24m', '24 30m', '24 meses', '3 6m', '30 36m', '6 12m', 'abertura do dia', 'acima 36m', 'ambiente de inflacao', 'ambiente de juros', 'ambiente macro', 'ao longo dos anos', 'cada mes', 'caixa disponivel', 'carteira de fiis', 'cenario macro', 'cenario macro atual', 'cenario macro para fiis', 'centro comercial', 'cnpj do', 'cnpj do administrador', 'como esta na b3', 'como fiis reagem', 'como foi a performance da minha carteira de fiis versus o ifix nos ultimos 12 meses', 'comparacao de dividendos', 'comparar com cdi', 'comparar com ibov'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 0.9, 'min_gap': 0.15, 'gap': 0.08693938752272845, 'accepted': False, 'source': 'final'}
- Dividendos de XPLG: warnings={'regex_like_token_detected': False, 'regex_like_tokens': [], 'multiword_token_detected': True, 'multiword_tokens': ['0 3m', '12 18m', '12 meses', '18 24m', '24 30m', '24 meses', '3 6m', '30 36m', '6 12m', 'abertura do dia', 'acima 36m', 'ambiente de inflacao', 'ambiente de juros', 'ambiente macro', 'ao longo dos anos', 'cada mes', 'caixa disponivel', 'carteira de fiis', 'cenario macro', 'cenario macro atual', 'cenario macro para fiis', 'centro comercial', 'cnpj do', 'cnpj do administrador', 'como esta na b3', 'como fiis reagem', 'como foi a performance da minha carteira de fiis versus o ifix nos ultimos 12 meses', 'comparacao de dividendos', 'comparar com cdi', 'comparar com ibov'], 'multi_ticker_downcast': False, 'bucket_filtered_entities': False, 'gate_apply_on_mismatch': False} | bucket= | gate={'min_score': 1.0, 'min_gap': 0.2, 'gap': 0.09369819641880998, 'accepted': False, 'source': 'final'}

## Hipóteses confirmadas/refutadas
- Regex-like tokens ou tokens multi-palavra marcados como suspeitos (match literal pode falhar).
- Multi-ticker pode ser reduzido a booleano/1 ticker quando resolve_ticker_from_text retorna apenas o primeiro.

## Próximos passos seguros (somente recomendações)
- Revisar tokens include com caracteres de regex ou espaços (substituir por tokens atômicos).
- Avaliar suporte explícito a múltiplos tickers no Planner (mantendo score).
- Revisar regras de bucket para entidades esperadas que estejam sendo filtradas.
