{% set rows = rows if rows is defined else [] %}

{# Só hidrata rows via results se rows estiver vazio (rewrite_only-safe) #}
{% if (not rows) and results is defined and meta is defined and meta.result_key is defined and (meta.result_key in results) %}
  {% set rows = results[meta.result_key] %}
{% endif %}

{% if not rows or rows|length == 0 %}
{# ticker_label seguro mesmo sem rows #}
{% set ticker_label = (
  meta.aggregates.ticker
  if meta is defined
     and meta.aggregates is defined
     and meta.aggregates.ticker is defined
  else 'FII'
) %}
Dados de imóveis do {{ ticker_label }} não disponíveis no momento.
{% else %}
{% set grouped = rows | groupby('ticker') %}

{% for ticker, items in grouped %}
**Imóveis do {{ ticker }} ({{ items|length }})**

| Nome do ativo | Classe | Localização | Área total (m²) | Unidades | Vacância | Inadimplência | Status | Atualizado em |
| --- | --- | --- | ---: | ---: | --- | --- | --- | --- |
{% for r in items %}
| {{ r.asset_name or '-' }} | {{ r.asset_class or '-' }} | {{ r.asset_address or '-' }} | {{ (r.total_area) ~ ' m²' if r.total_area is not none else '-' }} | {{ r.units_count if r.units_count is not none else '-' }} | {{ r.vacancy_ratio if r.vacancy_ratio is not none else '-' }} | {{ r.non_compliant_ratio if r.non_compliant_ratio is not none else '-' }} | {{ r.assets_status or '-' }} | {{ r.updated_at if r.updated_at else '-' }} |
{% endfor %}

_Fonte: CVM (dados públicos reportados pelos fundos e consolidados pela SIRIOS)._

{% if not loop.last %}
---
{% endif %}
{% endfor %}
{% endif %}
