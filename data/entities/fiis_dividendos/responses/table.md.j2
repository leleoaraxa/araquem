{% if rows and rows|length > 0 -%}
  {%- set first_ticker = rows[0].ticker -%}
  {%- set ns = namespace(multi=false) -%}
  {%- for r in rows -%}
    {%- if r.ticker != first_ticker -%}
      {%- set ns.multi = true -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if not ns.multi -%}
    {%- set ticker = first_ticker -%}
    {%- if rows|length == 1 -%}
      {%- set r = rows[0] -%}
O {{ ticker }} pagou {{ r.dividend_amt|currency_br }} por cota em {{ r.payment_date|date_br }} (posição em {{ r.traded_until_date|date_br }}).
    {%- else -%}
Nos últimos {{ rows|length }} pagamentos, o {{ ticker }} distribuiu dividendos nesta ordem:
{%-     for r in rows %}
- {{ r.payment_date|date_br }} — {{ r.dividend_amt|currency_br }} por cota (posição em {{ r.traded_until_date|date_br }})
{%-     endfor %}
    {%- endif -%}
  {%- else -%}
Histórico de dividendos por FII:
{%-   set ns_group = namespace(current=None) %}
{%-   for r in rows %}
    {%- if ns_group.current != r.ticker %}
{% if not loop.first %}
{% endif %}Pagamentos de **{{ r.ticker }}**:
      {%- set ns_group.current = r.ticker -%}
    {%- endif %}
- {{ r.payment_date|date_br }} — {{ r.dividend_amt|currency_br }} por cota (posição em {{ r.traded_until_date|date_br }})
{%-   endfor %}
  {%- endif -%}
{%- else -%}
{{ empty_message or "Sem dividendos para exibir." }}
{%- endif %}
