{% set rows = rows if rows is defined else [] %}

{% if (not rows) and results is defined and meta is defined and meta.result_key is defined and (meta.result_key in results) %}
  {% set rows = results[meta.result_key] %}
{% endif %}

{% if rows and rows|length > 0 %}
{% set tickers = rows | map(attribute='ticker') | unique | list %}

{% if tickers|length == 1 %}
**Processos do {{ tickers[0] }} ({{ rows|length }})**
{% else %}
**Processos encontrados ({{ rows|length }})**
{% endif %}

{% for ticker in tickers %}
{% if tickers|length > 1 %}
### {{ ticker }}
{% endif %}

{% for r in rows if r.ticker == ticker %}
- **{{ r.process_number or "-" }}**{% if r.judgment %} — {{ r.judgment }}{% endif %}
  - Instância: {{ r.instance or "-" }}
  - Início: {{ r.initiation_date if r.initiation_date else "-" }}
  - Valor da causa: {{ r.cause_amt if r.cause_amt is not none else "-" }}
  - Risco de perda: {{ r.loss_risk_pct if r.loss_risk_pct is not none else "-" }}
  - Partes: {{ r.process_parts or "-" }}
  - Fatos principais: {{ r.main_facts or "-" }}
  - Análise de impacto: {{ r.loss_impact_analysis or "-" }}
  - Atualizado em: {{ r.updated_at if r.updated_at else "-" }}
{% endfor %}

{% if tickers|length > 1 and not loop.last %}
---
{% endif %}
{% endfor %}

_Fonte: CVM (dados públicos reportados pelos fundos e consolidados pela SIRIOS)._

{% else %}
{{ empty_message or "Nenhum registro encontrado." }}
{% endif %}
