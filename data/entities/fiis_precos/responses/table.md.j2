{% set rows = rows if rows is defined else [] %}

{# Só hidrata rows via results se rows estiver vazio (rewrite_only-safe) #}
{% if (not rows) and results is defined and meta is defined and meta.result_key is defined and (meta.result_key in results) %}
  {% set rows = results[meta.result_key] %}
{% endif %}

{# ticker_label sempre definido (para empty state e título) #}
{% set ticker_label = (
  meta.aggregates.ticker
  if meta is defined and meta.aggregates is defined and meta.aggregates.ticker is defined
  else (rows[0].ticker if rows and rows[0].ticker is defined else "esse FII")
) %}

{% if rows and rows|length > 0 %}
**Preços recentes do {{ ticker_label }}**

| Data | Preço (R$) | Variação no dia |
| --- | ---: | ---: |
{% for r in rows[:6] %}
| {{ r.traded_at | date_br if r.traded_at else "-" }} | {{ r.close_price | currency_br if r.close_price is not none else "-" }} | {{ r.daily_variation_pct | percent_raw_br if r.daily_variation_pct is not none else "-" }} |
{% endfor %}
{% else %}
Não encontrei dados de preço para **{{ ticker_label }}**.
{% endif %}
