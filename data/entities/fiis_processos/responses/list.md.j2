{%- if rows and rows|length > 0 -%}
{%- set tickers = rows | map(attribute='ticker') | unique | list -%}
{%- if tickers|length == 1 -%}
**Processos do {{ tickers[0] }} ({{ rows|length }})**
{%- else -%}
**Processos encontrados ({{ rows|length }})**
{%- endif -%}

{%- for ticker in tickers -%}
{%- if tickers|length > 1 -%}
### {{ ticker }}
{%- endif -%}

{%- for r in rows if r.ticker == ticker -%}
- **{{ r.process_number }}**{%- if r.judgment %} — {{ r.judgment }}{%- endif %}

{%- set inst = (r.instance|string)|trim if r.instance is not none else "" -%}
{%- if inst %}  - Instância: {{ inst }}
{%- endif -%}

{%- set init = r.initiation_date if r.initiation_date is not none else "" -%}
{%- if init %}  - Início: {{ init | date_br }}
{%- endif -%}

{%- set cause = r.cause_amt if r.cause_amt is not none else "" -%}
{%- if cause %}  - Valor da causa: {{ cause | currency_br }}
{%- endif -%}

{%- set risk = (r.loss_risk_pct|string)|trim if r.loss_risk_pct is not none else "" -%}
{%- if risk %}  - Risco de perda: {{ risk }}
{%- endif -%}

{%- set parts = (r.process_parts|string)|trim if r.process_parts is not none else "" -%}
{%- if parts %}  - Partes: {{ parts }}
{%- endif -%}

{%- set mf = (r.main_facts|string)|trim if r.main_facts is not none else "" -%}
{%- if mf %}  - Fatos principais: {%- if mf|length > 400 -%}{{ mf[:400] }}…{%- else -%}{{ mf }}{%- endif -%}
{%- endif -%}

{%- set impact = (r.loss_impact_analysis|string)|trim if r.loss_impact_analysis is not none else "" -%}
{%- if impact %}  - Análise de impacto: {{ impact }}
{%- endif -%}

{%- set upd = r.updated_at if r.updated_at is not none else "" -%}
{%- if upd %}  - Atualizado em: {{ upd | date_br }}
{%- endif -%}

{%- endfor -%}
{%- endfor -%}
{%- else -%}
{{ empty_message or "Nenhum registro encontrado." }}
{%- endif -%}
