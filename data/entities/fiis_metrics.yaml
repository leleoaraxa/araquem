entity: fiis_metrics
private: false
description: Métricas compute-on-read por FII (base D-1 já garantida pela ingestão).

identifiers:
  - name: ticker
    description: Ticker do FII normalizado (AAAA11)

presentation:
  result_key: fii_metrics
  return_columns:
    - ticker
    - metric
    - value
    - window_months
    - period_start
    - period_end

columns:
  - { name: ticker,        alias: Ticker,           description: Código FII (AAAA11) }
  - { name: metric,        alias: Métrica,          description: Nome canônico da métrica }
  - { name: value,         alias: Valor,            description: Valor numérico da métrica }
  - { name: window_months, alias: Janela (meses),   description: Tamanho da janela temporal }
  - { name: period_start,  alias: Início do período,description: Data inicial }
  - { name: period_end,    alias: Fim do período,   description: Data final }

ask:
  intents: [metricas]
  keywords: [dy, "dividend yield", "preço médio", "soma dividendos", "contagem de dividendos", "media de preco"]
  synonyms:
    dy_avg: [dy, "dividend yield", "yield"]
    dividends_sum: ["soma de dividendos", "soma proventos"]
    dividends_count: ["quantidade de dividendos", "contagem de dividendos"]
    price_avg: ["preço médio", "media de preco"]
  weights:
    identifiers: 2.0
    keywords: 1.0
    synonyms: 0.5

# compute-on-read (SQL parametrizado pelo Builder)
metrics:
  - name: dividends_sum
    description: Soma de dividendos no período (R$ por cota)
    sql: |
      WITH dividends_window AS (
        SELECT
          d.ticker,
          d.payment_date,
          d.dividend_amt,
          d.traded_until_date,
          ROW_NUMBER() OVER (
            PARTITION BY d.ticker
            ORDER BY
              d.payment_date DESC,
              d.traded_until_date DESC,
              COALESCE((d.updated_at)::timestamp, (d.created_at)::timestamp, d.payment_date::timestamp) DESC
          ) AS rn
        FROM fiis_dividendos d
        WHERE d.ticker = {{ticker}}
          AND (
            ({{window_kind}} = 'months' AND d.payment_date BETWEEN {{period_start}} AND {{period_end}})
            OR {{window_kind}} = 'count'
          )
      )
      SELECT
        d.ticker,
        'dividends_sum' AS metric,
        COALESCE(SUM(d.dividend_amt), 0)::numeric AS value,
        {{window_months}}::int AS window_months,
        {{period_start}}::date AS period_start,
        {{period_end}}::date AS period_end
      FROM dividends_window d
      WHERE {{window_kind}} = 'months'
         OR d.rn <= COALESCE({{window_value}}::int, 0)
      GROUP BY d.ticker

  - name: dividends_count
    description: Contagem de pagamentos no período
    sql: |
      WITH dividends_window AS (
        SELECT
          d.ticker,
          d.payment_date,
          d.traded_until_date,
          ROW_NUMBER() OVER (
            PARTITION BY d.ticker
            ORDER BY
              d.payment_date DESC,
              d.traded_until_date DESC,
              COALESCE((d.updated_at)::timestamp, (d.created_at)::timestamp, d.payment_date::timestamp) DESC
          ) AS rn
        FROM fiis_dividendos d
        WHERE d.ticker = {{ticker}}
          AND (
            ({{window_kind}} = 'months' AND d.payment_date BETWEEN {{period_start}} AND {{period_end}})
            OR {{window_kind}} = 'count'
          )
      )
      SELECT
        d.ticker,
        'dividends_count' AS metric,
        COUNT(*)::numeric AS value,
        {{window_months}}::int AS window_months,
        {{period_start}}::date AS period_start,
        {{period_end}}::date AS period_end
      FROM dividends_window d
      WHERE {{window_kind}} = 'months'
         OR d.rn <= COALESCE({{window_value}}::int, 0)
      GROUP BY d.ticker

  - name: price_avg
    description: Preço médio de fechamento no período
    sql: |
      SELECT
        p.ticker,
        'price_avg' AS metric,
        AVG(p.close_price)::numeric AS value,
        {{window_months}}::int AS window_months,
        {{period_start}}::date AS period_start,
        {{period_end}}::date AS period_end
      FROM fiis_precos p
      WHERE p.ticker = {{ticker}}
        AND p.traded_at BETWEEN {{period_start}} AND {{period_end}}
      GROUP BY p.ticker

  - name: dy_avg
    description: "Dividend Yield médio no período (média dos DY diários de cada pagamento)"
    sql: |
      WITH dividends_window AS (
        SELECT
          d.ticker,
          d.payment_date,
          d.dividend_amt,
          d.traded_until_date,
          ROW_NUMBER() OVER (
            PARTITION BY d.ticker
            ORDER BY
              d.payment_date DESC,
              d.traded_until_date DESC,
              COALESCE((d.updated_at)::timestamp, (d.created_at)::timestamp, d.payment_date::timestamp) DESC
          ) AS rn
        FROM fiis_dividendos d
        WHERE d.ticker = {{ticker}}
          AND (
            ({{window_kind}} = 'months' AND d.payment_date BETWEEN {{period_start}} AND {{period_end}})
            OR {{window_kind}} = 'count'
          )
      ),
      limited_dividends AS (
        SELECT *
        FROM dividends_window dw
        WHERE {{window_kind}} = 'months'
           OR dw.rn <= COALESCE({{window_value}}::int, 0)
      ),
      dy_calc AS (
        SELECT
          ld.ticker,
          ld.payment_date,
          ld.traded_until_date,
          ld.dividend_amt,
          px.close_price,
          CASE
            WHEN px.close_price IS NULL OR px.close_price = 0 THEN NULL
            ELSE ld.dividend_amt / px.close_price
          END AS dy_diario
        FROM limited_dividends ld
        LEFT JOIN LATERAL (
          SELECT p.close_price
          FROM fiis_precos p
          WHERE p.ticker = ld.ticker
            AND p.traded_at::date <= COALESCE((ld.traded_until_date)::date, (ld.payment_date)::date)
          ORDER BY p.traded_at DESC
          LIMIT 1
        ) px ON TRUE
      )
      SELECT
        {{ticker}} AS ticker,
        'dy_avg' AS metric,
        AVG(dy_diario)::numeric AS value,
        {{window_months}}::int AS window_months,
        {{period_start}}::date AS period_start,
        {{period_end}}::date AS period_end
      FROM dy_calc
